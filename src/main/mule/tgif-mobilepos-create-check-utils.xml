<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:java="http://www.mulesoft.org/schema/mule/java"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/java http://www.mulesoft.org/schema/mule/java/current/mule-java.xsd">

	<sub-flow name="create-process-sub-flow"
		doc:id="1e2ae279-7aa2-4b27-996c-bd2f6d1c3d5b">
		<ee:transform doc:name="Post Transaction XML"
			doc:id="50bbe9a6-d123-4a7e-be7c-f29e81944d9b">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable
					resource="dwl/create-check/pos-transaction-xml.dwl"
					variableName="postTransactionXML" />
			</ee:variables>
		</ee:transform>
		<set-variable
			value="#[output application/json&#10;---&#10;{&#10;	methodName: 'CreateCheck',&#10;	storeId: if ( vars.storeId != null ) vars.storeId else vars.vrStoreId,&#10;	checkNumber: 'Null',&#10;	checkSequence: 'Null',&#10;	employeeNumber: 'Null',&#10;	tableNumber: 'Null',&#10;	status: '1',&#10;	message: vars.postTransactionXML&#10;}]"
			doc:name="logData" doc:id="9f8e1fa9-a382-41d5-b644-40be1d39fedb"
			variableName="logData" />
		<flow-ref doc:name="insert-online-ordering-logs"
			doc:id="744dd878-4cf4-4e6f-8ff1-a713c0f72d18"
			name="insert-online-ordering-logs" />
		<flow-ref doc:name="get-store-ip-properties"
			doc:id="ae14da2f-e4f5-484f-bd63-a34d4548ca0e"
			name="get-store-ip-properties" />
		<choice doc:name="IP Address is not null"
			doc:id="6f6d160c-3f20-4a3d-b3c3-8badbe149ab2">
			<when expression="#[vars.storeIpProperties.serverIp != null]">
				<flow-ref doc:name="call-respos-api-create-check"
					doc:id="b0f44bc1-ad05-4617-8e93-889e23622ba1"
					name="call-respos-api-create-check" />
			</when>
			<otherwise>
				<set-variable
					value="#['Store Number ' ++ vars.storeId ++ ' not setup in mulesoft for online ordering']"
					doc:name="emailMessage"
					doc:id="c218e312-47b8-4bae-87c8-82bbe7a2f555"
					variableName="emailMessage" />
				<flow-ref doc:name="send-email-notification"
					doc:id="48b28b59-9bb8-4809-b029-878bf3ef4108"
					name="send-email-notification" />
				<set-variable
					value="#[output application/json&#10;---&#10;{&#10;	methodName: 'CreateCheck',&#10;	storeId: if ( vars.storeId != null ) vars.storeId else vars.vrStoreId,&#10;	checkNumber: 'Null',&#10;	checkSequence: 'Null',&#10;	employeeNumber: 'Null',&#10;	tableNumber: 'Null',&#10;	status: '1',&#10;	message: &quot;Store server not reachable, able to reach Firewall&quot;&#10;}]"
					doc:name="logData" doc:id="4046e051-c0d9-401e-832d-367a2ab6264b"
					variableName="logData" />
				<flow-ref doc:name="insert-online-ordering-logs"
					doc:id="8f0db013-2ba9-4548-9df7-bf8489098da2"
					name="insert-online-ordering-logs" />
				<choice doc:name="Check Delivery Partner"
					doc:id="3d9c0dc0-0227-4144-a18f-cf2b45166163">
					<when
						expression='#[vars.tenderId.messageSubject != "Grub Hub Delivery" and vars.tenderId.messageSubject != "Uber Eats Delivery" and vars.tenderId.messageSubject != "Postmates Delivery" and vars.tenderId.messageSubject != "Door Dash Delivery"]'>
						<ee:transform doc:name="Transform Message"
							doc:id="ab2d42e5-9fe6-48c0-b0ed-b6e3f8a3b1e9">
							<ee:message>
								<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	createcheck: {
		result: {
			status: "failure",
			message: "Unable to find check Bad Response returned from micros"
		}
	}
}]]></ee:set-payload>
							</ee:message>
							<ee:variables>
								<ee:set-variable
									variableName="deliveryOrderDetails"><![CDATA[%dw 2.0
output application/json
---
{
	deliveryPartnerName: vars.tenderId.messageSubject,
	storeId: vars.storeId,
	orderId: vars.createCheckVars.cartId,
	checkNumber: 'NULL',
	dayofBusiness: (now() >> "CST") as Date {
		format: "MM/dd/yyyy"
	},
	deliveryMethod: ' Pickup',
	status: 'failed',
	subTotal: if ( vars.initialPayload.createcheck.payment.subtotalNoDiscountsPlusTaxes == null or vars.initialPayload.createcheck.payment.taxTotal ==  null ) 'NULL'
	else (((vars.initialPayload.createcheck.payment.subtotalNoDiscountsPlusTaxes as Number) - (vars.initialPayload.createcheck.payment.taxTotal as Number)) as String),
	taxTotal: vars.initialPayload.createcheck.payment.taxTotal,
	agentId: vars.initialPayload.createcheck.agentId default ""
}]]></ee:set-variable>
							</ee:variables>
						</ee:transform>
						<flow-ref doc:name="insert-delivery-order-details"
							doc:id="70f4a97f-6b4e-45fe-9660-89171b457e2d"
							name="insert-delivery-order-details" />
					</when>
					<otherwise>
						<ee:transform doc:name="Transform Message"
							doc:id="a12fa88f-2bb0-49ff-ac53-8b9564e8ccc1">
							<ee:message>
								<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
{
	createcheck: {
		result: {
			status: "failure",
			message: "Store server not reachable, able to reach Firewall"
		}
	}
}]]></ee:set-payload>
							</ee:message>
						</ee:transform>
						<logger level="INFO" doc:name="INFO: Logger"
							doc:id="d83ff175-bc3f-4943-a598-6c72e9592849"
							message="Grub Hub delivery or Doordash delivery or UberEats delivery or Postmates delivery" />
					</otherwise>
				</choice>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="call-respos-api-create-check"
		doc:id="35273ee0-bf9f-4cc6-8db6-8ec4ef20b8c3">
		<logger level="INFO" doc:name="DEBUG: Service Request"
			doc:id="eb404802-8e0c-4d23-9486-0646951bd45f"
			message="ResposAPI Request=#[vars.postTransactionXML]" />
		<http:request method="POST" doc:name="Request ResPosApi"
			doc:id="9fa4edef-5fb2-4177-9679-76587c8c8d44"
			target="createCheckServiceResponse"
			config-ref="HTTP_Request_configuration"
			path="/ResPosApiWeb/ResPosApiWeb.asmx">
			<reconnect frequency="${resposapi.reconnect.frequency}"
				count="${resposapi.reconnect.count}" />
			<http:body><![CDATA[#[%dw 2.0
output text/xml
---
vars.postTransactionXML]]]></http:body>
			<http:response-validator>
				<http:success-status-code-validator
					values="200..599" />
			</http:response-validator>
		</http:request>
		<logger level="INFO" doc:name="DEBUG: Service Response"
			doc:id="96459f08-2925-4281-933f-1c2178a00978"
			message="ResposAPI Response=#[vars.createCheckServiceResponse]" />
		<ee:transform doc:name="Create Check Service Response"
			doc:id="8c2b1e09-2dd5-4384-b90c-1e8da97eb771">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable
					variableName="createCheckServiceResponse"><![CDATA[%dw 2.0
output application/json
ns soapenv http://www.w3.org/2003/05/soap-envelope
---
if ( vars.createCheckServiceResponse.soapenv#Envelope.soapenv#Body.PostTransactionExResponse != null ) {
	status: "Success",
	response: vars.createCheckServiceResponse.soapenv#Envelope.soapenv#Body.PostTransactionExResponse
} else {
	status: "Failed",
	response: vars.createCheckServiceResponse.soapenv#Envelope.soapenv#Body.soapenv#Fault.detail.hresult replace "-" with ""
}
]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<choice doc:name="Check Response"
			doc:id="f3080e2e-4f5a-4e52-8dc4-100c8ce8f2b2">
			<when
				expression="#[vars.createCheckServiceResponse.status == 'Success']">
				<logger level="INFO" doc:name="INFO: Success"
					doc:id="2b8e5f18-b474-40e1-8f3b-cdcff41af5df"
					message="Web Service call was successfull" />
				<flow-ref doc:name="send-order-to-mail"
					doc:id="e8492c03-e28e-4955-91e4-ce1ba4689c53"
					name="send-order-to-mail" />
				<wsc:consume doc:name="TGIF Web Service call"
					doc:id="f9a1aff4-9be1-4241-a5ee-e3d52b89a9ed"
					config-ref="Web_Service_Consumer_Config" operation="GetMicrosDOB"
					target="tgifServiceResponse">
					<wsc:message>
						<wsc:body><![CDATA[#[%dw 2.0
 				output application/xml
 				ns tem http://tempuri.org/ 
 				--- 
 				{ 
 				tem#GetMicrosDOB: {
 				} 
 				}]]]></wsc:body>
					</wsc:message>
				</wsc:consume>
				<set-variable
					value="#[%dw 2.0
 				&#10;output application/json 
 				&#10;ns ns0 http://tempuri.org/ 
 				&#10;
				&#10;vars.tgifServiceResponse.ns0#GetMicrosDOBResponse.ns0#GetMicrosDOBResult 
					as String]"
					doc:name="dayOfBusiness"
					doc:id="da06fa6e-77cf-4f45-a8f2-d124d1d95952"
					variableName="dayOfBusiness" />
				<set-variable value="2021-04-08T00:00:00"
					doc:name="Set Variable"
					doc:id="ea2f4b17-a6d0-477d-94b4-a1b66e986485"
					variableName="dayOfBusiness" />
				<ee:transform doc:name="Create Check JSON"
					doc:id="753445b9-e916-4f50-b0fb-54fc4452de97">
					<ee:message>
						<ee:set-payload
							resource="dwl/create-check/create-check.dwl" />
					</ee:message>
					<ee:variables>
					</ee:variables>
				</ee:transform>
				<set-variable
					value="#[output application/json
&#10;---
&#10;{
&#10;	methodName: 'CreateCheck',
&#10;	storeId: if ( vars.storeId != null ) vars.storeId else vars.vrStoreId,
&#10;	checkNumber: vars.createCheck.createcheck.check.checkId,
&#10;	checkSequence: vars.createCheck.createcheck.check.checkSeq,
&#10;	employeeNumber: vars.createCheck.createcheck.check.employeeNumber,
&#10;	tableNumber: vars.createCheck.createcheck.check.tableNumber,
&#10;	status: '1',
&#10;	message: vars.createCheck
&#10;}]"
					doc:name="logData" doc:id="501687fc-4c6d-4bff-8caf-236325c19453"
					variableName="logData" />
				<flow-ref doc:name="insert-online-ordering-logs"
					doc:id="0b7bcbbe-ff9d-4725-b9b8-866e1957c3fa"
					name="insert-online-ordering-logs" />
				<choice doc:name="Check Delivery Partner"
					doc:id="d49fb98a-9cfd-4395-aaca-7a1f7b18a677">
					<when
						expression='#[using(subject = vars.tenderId.messageSubject) subject != "Grub Hub Delivery" and subject != "Uber Eats Delivery" and subject != "Postmates Delivery" and subject != "Door Dash Delivery"]'>
						<set-variable
							value="#[{
&#10;	storeId: vars.storeId,
&#10;	cartId: vars.createCheckVars.cartId,
&#10;	payload: vars.createCheck,
&#10;	dayofBusiness: vars.createCheck.dayOfBusiness
&#10;}]"
							doc:name="Cart Log Data"
							doc:id="ed51ac30-1a59-4f9b-b5b2-2ea898ce2922"
							variableName="logData" />
						<flow-ref doc:name="insert-cart-id-logs"
							doc:id="a2e3a187-34bc-4297-827b-5490849d5e86"
							name="insert-cart-id-logs" />
						<set-variable
							value="#[%dw 2.0
&#10;output application/json
&#10;---
&#10;{
&#10;	deliveryPartnerName: vars.tenderId.messageSubject,
&#10;	storeId: vars.storeId,
&#10;	orderId: vars.createCheckVars.cartId,
&#10;	checkNumber: vars.createCheck.createcheck.check.checkId,
&#10;	dayofBusiness:vars.createCheck.createcheck.dayOfBusiness,
&#10;	deliveryMethod: ' Pickup',
&#10;	status: 'success',
&#10;	subTotal: if ( vars.initialPayload.createcheck.payment.subtotalNoDiscountsPlusTaxes == null or vars.initialPayload.createcheck.payment.taxTotal ==  null ) 'NULL'
&#10;	else (((vars.initialPayload.createcheck.payment.subtotalNoDiscountsPlusTaxes as Number) - (vars.initialPayload.createcheck.payment.taxTotal as Number)) as String),
&#10;	taxTotal: vars.initialPayload.createcheck.payment.taxTotal,
&#10;	agentId: vars.initialPayload.createcheck.agentId default &quot;&quot;
&#10;}]"
							doc:name="Delivery Order Log Data"
							doc:id="17154e44-d1ce-4900-920a-5d8a6f28a34a"
							variableName="deliveryOrderDetails" />
						<flow-ref doc:name="insert-delivery-order-details"
							doc:id="ff9a41bc-1411-448e-8ab7-45ed3e41221b"
							name="insert-delivery-order-details" />
					</when>
					<otherwise>
						<logger level="INFO" doc:name="INFO: Logger"
							doc:id="f66466eb-8842-4b2f-9c52-948381885ce5"
							message="Grub Hub delivery or Doordash delivery or UberEats delivery or Postmates delivery" />
					</otherwise>
				</choice>
			</when>
			<otherwise>
				<logger level="INFO" doc:name="INFO: Web Service call failed"
					doc:id="505d87b3-2ebb-4380-9880-466a328cc989"
					message="Web Service call failed" />
				<set-variable
					value="#[vars.createCheckServiceResponse.response]"
					doc:name="errorCode" doc:id="3db98083-6e17-4a75-a250-bd60e4434406"
					variableName="errorCode" />
				<flow-ref doc:name="get-error-code-details"
					doc:id="292f7a99-1c92-408a-96ca-f819782c8a2d"
					name="get-error-code-details" />
				<ee:transform doc:name="Transform Message"
					doc:id="5d878d2f-6310-48a3-bcbd-4c1242e84f31">
					<ee:message>
						<ee:set-payload
							resource="dwl/create-check/failure-payload.dwl" />
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="emailMessage"><![CDATA[%dw 2.0
output application/json
---
if ( vars.createCheckServiceResponse.response == "Store server not reachable, able to reach Firewall" ) "Store server not reachable, able to reach Firewall " ++ vars.storeId ++ " in CreateCheck method"
else if ( vars.createCheckServiceResponse.response == "Store network unreachable at Firewall" ) "Store network unreachable at Firewall " ++ vars.storeId ++ " in CreateCheck method"
else ""]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<choice doc:name="Send Email?"
					doc:id="cb9ed292-6d1a-41c7-b239-f5895451070d">
					<when
						expression='#[vars.createCheckServiceResponse.response == "Store server not reachable, able to reach Firewall" or vars.createCheckServiceResponse.response == "Store network unreachable at Firewall"]'>
						<flow-ref doc:name="send-email-notification"
							doc:id="5f368275-c3ad-41e1-9900-bd30aa602269"
							name="send-email-notification" />
					</when>
					<otherwise>
						<logger level="INFO" doc:name="INFO: No email triggered"
							doc:id="ec716034-6070-4ff0-819b-1c78dbe9c4f9"
							message="No Email triggered" />
					</otherwise>
				</choice>
				<choice doc:name="Check Delivery Partner"
					doc:id="7fe5fe57-b43e-4160-9a36-c7d6257382d8">
					<when
						expression='#[vars.tenderId.messageSubject != "Grub Hub Delivery" and vars.tenderId.messageSubject != "Uber Eats Delivery" and vars.tenderId.messageSubject != "Postmates Delivery" and vars.tenderId.messageSubject != "Door Dash Delivery"]'>
						<set-variable
							value="#[%dw 2.0
&#10;output application/json
&#10;---
&#10;{
&#10;	deliveryPartnerName: vars.tenderId.messageSubject,
&#10;	storeId: vars.storeId,
&#10;	orderId: vars.createCheckVars.cartId,
&#10;	checkNumber: 'NULL',
&#10;	dayofBusiness: (now() &gt;&gt; &quot;CST&quot;) as Date {
&#10;		format: &quot;MM/dd/yyyy&quot;
&#10;	},
&#10;	deliveryMethod: ' Pickup',
&#10;	status: 'success',
&#10;	subTotal: if ( vars.initialPayload.createcheck.payment.subtotalNoDiscountsPlusTaxes == null or vars.initialPayload.createcheck.payment.taxTotal ==  null ) 'NULL'
&#10;	else (((vars.initialPayload.createcheck.payment.subtotalNoDiscountsPlusTaxes as Number) - (vars.initialPayload.createcheck.payment.taxTotal as Number)) as String),
&#10;	taxTotal: vars.initialPayload.createcheck.payment.taxTotal,
&#10;	agentId: vars.initialPayload.createcheck.agentId default &quot;&quot;
&#10;}]"
							doc:name="Delivery Order Log Data"
							doc:id="c6201516-9d99-4f97-ba6f-262b0bdf448a"
							variableName="deliveryOrderDetails" />
						<flow-ref doc:name="insert-delivery-order-details"
							doc:id="d070b233-1fe4-44d8-ba04-ffafbbeb70b3"
							name="insert-delivery-order-details" />
					</when>
					<otherwise>
						<logger level="INFO" doc:name="INFO: Logger"
							doc:id="9f8ad17e-977e-4acf-b204-3f0003d1a0f4"
							message="Grub Hub delivery or Doordash delivery or UberEats delivery or Postmates delivery" />
					</otherwise>
				</choice>
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="send-order-to-mail"
		doc:id="75b17d5b-cc56-4bbe-87f2-16ba970ff8cd">
		<logger level="INFO"
			doc:name="INFO: Called send order to email flow"
			doc:id="b2379ba5-e6d2-469e-a017-194eea64078d"
			message="Called send order to email flow" />
		<ee:transform doc:name="Stripes Code"
			doc:id="c53e0e1f-cdc0-4a29-bead-23cceee403ea">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="stripesCode"><![CDATA[%dw 2.0
output application/json
import java!com::api::tgif::mobilepos::util::CommonUtil
fun getMonth(date) = ((date splitBy " ")[0] replace "'" with "-") as Date {format: "MMMdd-yy"} as String {format: "M"} as Number
fun getDay(date) = ((date splitBy " ")[0] replace "'" with "-") as Date {format: "MMMdd-yy"} as String {format: "d"} as Number
fun getChkNumber(date) = (date splitBy " ")[1] as Number
fun getArgs() = {
    month: getMonth(trim((vars.createCheckServiceResponse.response.ppCheckPrintLines.string splitBy "\n")[10])),
    day: getDay(trim((vars.createCheckServiceResponse.response.ppCheckPrintLines.string splitBy "\n")[10])),
    checkNumber: getChkNumber(trim((vars.createCheckServiceResponse.response.ppCheckPrintLines.string splitBy "\n")[9])) 
}
---
CommonUtil::StripesCode(vars.storeId as Number, vars.createCheckServiceResponse.response.pTotalsResponse.TotalsSubTotal as Number, getArgs().month,getArgs().day,getArgs().checkNumber)
]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<async doc:name="Async"
			doc:id="08f77de5-76c8-4a3e-97bd-d622d587bb6d">
			<ee:transform doc:name="Set Email Message"
				doc:id="d6a42f53-8e89-4c2f-afe4-25fc145b50f6">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable
						resource="dwl/create-check/email-message.dwl"
						variableName="emailMessage" />
				</ee:variables>
			</ee:transform>
			<choice doc:name="Check Email Message"
				doc:id="ce22d4e6-ff91-47de-a122-916d8e0e6343">
				<when
					expression='#[vars.emailMessage != "Print Check Lines not found"]'>
					<flow-ref doc:name="send-create-email-notification"
						doc:id="69cdc0c1-6b90-4042-a983-97f5e879becb"
						name="send-create-email-notification" />
					<logger level="INFO" doc:name="INFO: Logger"
						doc:id="115eb29a-50e2-4584-91b9-18d761393e42"
						message="Email Online Order Check Lines to store Method Completed" />
					<set-variable
						value="#[output application/json&#10;---&#10;{&#10;	methodName: 'SendOrdertoEmail',&#10;	storeId: if ( vars.storeId != null ) vars.storeId else vars.vrStoreId,&#10;	checkNumber: 'Null',&#10;	checkSequence: 'Null',&#10;	employeeNumber: 'Null',&#10;	tableNumber: 'Null',&#10;	status: '1',&#10;	message: vars.emailMessage&#10;}]"
						doc:name="logData" doc:id="d8b12544-fd38-461a-a21a-a3982dd8d164"
						variableName="logData" />
					<flow-ref doc:name="insert-online-ordering-logs"
						doc:id="419ff3e6-58c4-4b3a-9d49-fe2ad2138fb9"
						name="insert-online-ordering-logs" />
				</when>
				<otherwise>
					<set-variable
						value="#[if(vars.emailMessage == &quot;Print Check Lines not found&quot;) &quot;No print check lines received from micros for store &quot; ++ vars.storeId ++ &quot; in CreateCheck method&quot;&#10;else 'Error occurred while reading Print Check Lines for store ' + vars.storeId ++ &quot; in CreateCheck method. Error message : Exception in Print Check Lines&quot;]"
						doc:name="emailMessage"
						doc:id="026a1fbc-73a0-4962-8a4e-0044dad162be"
						variableName="emailMessage" />
					<flow-ref doc:name="send-email-notification"
						doc:id="d8ac5fa2-c70b-406f-87d1-6a34cef65b5d"
						name="send-email-notification" />
					<logger level="INFO" doc:name="INFO: Logger"
						doc:id="5c5d5a2a-cdd6-45a3-bdc8-4957f6838b56"
						message="Read Print Check Lines Method Completed with Errors" />
					<set-variable
						value="#[output application/json&#10;---&#10;{&#10;	methodName: 'SendOrdertoEmail',&#10;	storeId: if ( vars.storeId != null ) vars.storeId else vars.vrStoreId,&#10;	checkNumber: 'Null',&#10;	checkSequence: 'Null',&#10;	employeeNumber: 'Null',&#10;	tableNumber: 'Null',&#10;	status: '0',&#10;	message: vars.emailMessage&#10;}]"
						doc:name="logData" doc:id="67298980-ed1d-4cc3-842c-9970212fb860"
						variableName="logData" />
					<flow-ref doc:name="insert-online-ordering-logs"
						doc:id="a90ee520-7ddb-49dc-90bc-ea1c30ed4b5a"
						name="insert-online-ordering-logs" />
				</otherwise>
			</choice>
		</async>
	</sub-flow>
	<sub-flow name="get-delivery-partner-orders"
		doc:id="15728ae5-7d4a-4169-a607-f7d052bbd35b">
		<logger level="INFO" doc:name="INFO: Start"
			doc:id="de214dd4-328b-492c-a62a-bcb118ce41ec"
			message="Enter Get Delivery Partner order from Object Store flow" />
		<ee:transform doc:name="Delivery Partner"
			doc:id="af2ba628-f84f-4976-8cdd-16f87f99e244">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="retrieveKey"><![CDATA[%dw 2.0
output application/json
---
if(vars.createCheckVars.paymentCardType == "UBE") "uberEatsOrderType"
else if(vars.createCheckVars.paymentCardType == "DD") "doorDashOrderType"
else if(vars.createCheckVars.paymentCardType == "GH") "grubHubOrderType"
else if(vars.createCheckVars.paymentCardType == "PM") "postmatesOrderType"
else ""]]></ee:set-variable>
				<ee:set-variable variableName="deliveryPartner"><![CDATA[%dw 2.0
output application/json
---
if(vars.createCheckVars.paymentCardType == "UBE") "UberEats"
else if(vars.createCheckVars.paymentCardType == "DD") "DoorDash"
else if(vars.createCheckVars.paymentCardType == "GH") "GrubHub"
else if(vars.createCheckVars.paymentCardType == "PM") "Postmates"
else ""]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<os:retrieve doc:name="Retrieve Delivery Partner Orders"
			doc:id="d7291d14-abbc-45cf-afc0-c6c5d20cac07"
			key="#[vars.retrieveKey]" objectStore="Object_store"
			target="orderType" />
		<set-variable
			value="#[output application/json --- ((vars.orderType filter ($.store_id as String == vars.storeId)).order_type_id)[0]]"
			doc:name="orderType" doc:id="8742b20d-326b-4960-9851-0f4bcb2a1c28"
			variableName="orderType" />
		<logger level="INFO" doc:name="INFO: Exit"
			doc:id="8a9de6d3-bff9-4876-9351-959f029e2759"
			message="Exit Get Delivery Partner order from Object Store flow" />
	</sub-flow>
	<sub-flow name="get-tender-media-details"
		doc:id="7b1214fa-07dc-49ea-81e2-5896fad52029">
		<logger level="INFO" doc:name="INFO: Enter"
			doc:id="0dc9acae-7568-4c3a-a0e3-f0783b1136e2"
			message="Enter Get Tender details from Object Store" />
		<os:retrieve doc:name="Retrieve Tender Media Details"
			doc:id="507a6e87-0240-4344-8496-ec46c5a4297f" key="tenderMedia"
			objectStore="Object_store" target="tenderMedia" />
		<set-variable
			value="#[output application/json --- ((vars.tenderMedia filter ($.store_id as String == vars.storeId)).tender_media_object_number)[0]]"
			doc:name="tenderMedia" doc:id="62bfb746-3988-4842-9d04-40cb10720289"
			variableName="tenderMedia" />
		<logger level="INFO" doc:name="INFO: Exit"
			doc:id="35defe16-3907-4c9f-963f-b50c2e5b09d2"
			message="Exit Get Tender details from Object Store" />
	</sub-flow>
	<sub-flow name="insert-duplicate-orders"
		doc:id="2e4a93df-ea30-4df5-bc02-c25701e92a61">
		<set-variable
			value='#[if(vars.tenderId.messageSubject != "Online Orders") "PayInStore" else "OLO"]'
			doc:name="deliveryPartner"
			doc:id="ca9a7114-1b28-4c3b-8cc6-c0bb9471c395"
			variableName="deliveryPartner" />
		<db:stored-procedure
			doc:name="Call prc_validate_olo_duplicate_orders_insert"
			doc:id="940a2703-243a-401c-a486-1c18c3b9c9a6"
			config-ref="Database_Config_Mule_Interface">
			<db:sql><![CDATA[{ call dbo.prc_validate_olo_duplicate_orders_insert(:store_id,:cart_id,:order_id,:day_of_business,:delivery_partner_name)}]]></db:sql>
			<db:input-parameters><![CDATA[#[{
	store_id: vars.logData.storeId,
	cart_id: vars.logData.cartId,
	orderId: vars.logData.orderId,
	day_of_business: vars.logData.dayOfBusiness,
	delivery_partner_name: vars.deliveryPartner
}]]]></db:input-parameters>
		</db:stored-procedure>
	</sub-flow>
	<sub-flow name="insert-delivery-order-details"
		doc:id="4e584271-571b-4a8e-a5b4-db07e0572366">
		<async doc:name="Async"
			doc:id="d5228358-0df0-47d8-a6cd-420a0005c603">
			<db:stored-procedure
				doc:name="Insert Delivery Order Details"
				doc:id="aea8f562-a88a-44a8-a791-d4a65831249f"
				config-ref="Database_Config_Mule_Interface">
				<db:sql><![CDATA[{ call dbo.prc_delivery_order_details_insert(:delivery_partner_name,:store_id,:order_id,:check_number,:day_of_business,:delivery_method,:status,:sub_total,:tax_total,:agent_id)}]]></db:sql>
				<db:input-parameters><![CDATA[#[{
	delivery_partner_name: vars.deliveryOrderDetails.deliveryPartnerName,
	store_id: vars.deliveryOrderDetails.storeId,
	order_id: vars.deliveryOrderDetails.orderId,
	check_number: vars.deliveryOrderDetails.checkNumber,
	day_of_business: if ( vars.deliveryOrderDetails.dayOfBusiness != "0001-01-01" ) vars.deliveryOrderDetails.dayOfBusiness else (now() >> "CST") as Date {
		format: "MM/dd/yyyy"
	},
	delivery_method: vars.deliveryOrderDetails.deliveryMethod,
	status: vars.deliveryOrderDetails.status,
	sub_total:vars.deliveryOrderDetails.subTotal,
	tax_total:vars.deliveryOrderDetails.taxTotal,
	agent_id: vars.deliveryOrderDetails.agentId
}]]]></db:input-parameters>
			</db:stored-procedure>
		</async>
	</sub-flow>

	<sub-flow name="send-create-email-notification"
		doc:id="eca0ef79-a105-453f-adc4-9cd4aca34bae">
		<db:stored-procedure
			doc:name="Send Email Notification"
			doc:id="74a24c25-844d-4cea-98e2-bbf6fdb34905"
			config-ref="Database_Config_Depot" target="sentEmail">
			<db:sql><![CDATA[{call prc_RemoteMail_CreateMessage(:id, :store, :type, :subject,:body, :param1, :param2)}]]></db:sql>
			<db:input-parameters><![CDATA[#[{
	id: 1,
	store: if (sizeOf(vars.storeId) < 4) (1 to (4 - sizeOf(vars.storeId))) map "#" joinBy "" ++ vars.storeId else vars.storeId,
	'type': null,
	subject: vars.tenderId.messageSubject,
	body: vars.emailMessage,
	param1: null,
	param2: null
}]]]></db:input-parameters>
		</db:stored-procedure>
	</sub-flow>
	<!-- <sub-flow name="serialized-coupon-sub-flow" doc:id="5db58ee3-d2b3-4a87-9b75-eca067665cff" 
		> <logger level="INFO" doc:name="INFO: Start" doc:id="513cc75d-a817-4074-aa82-95c0dcde8ce5" 
		message="#[vars.storeId] - Create Check Validate Serialized Coupon"/> <ee:transform 
		doc:name="Transform Message" doc:id="2416746b-49bc-467f-a82b-9d92ef40f3b8" 
		> <ee:message > </ee:message> <ee:variables > <ee:set-variable variableName="lookupData" 
		><![CDATA[%dw 2.0 output application/json -&#45;&#45; { requestCode: 'SV_ACCEPT_COUPON', 
		retransmit: 'N', terminalId: '1', siteId: 1, employeeId: '98008', posPlatform: 
		'3700', amount: '0.00', localDate: now() as Date { format: "yyyyMMdd" }, 
		localTime: now() as DateTime { format:"HHmmss" }, revenueCenter: '5', terminalType: 
		'1', version: '8', timeOut: '120', language: 'en_US', currency: 'USD', sequence: 
		'01', quantity: '1' }]]></ee:set-variable> <ee:set-variable variableName="couponStoreId" 
		><![CDATA[%dw 2.0 output application/json -&#45;&#45; vars.storeId]]></ee:set-variable> 
		</ee:variables> </ee:transform> <choice doc:name="Choice" doc:id="a491ed30-77d0-453b-92e7-211e45d7003e" 
		> <when expression="#[vars.createCheckVars.orderDiscountNum == null and vars.orderDiscountNum.serializedCouponCode 
		!= null]"> <logger level="INFO" doc:name="INFO: Coupon Found" doc:id="c118af9e-4a79-4fc5-ac55-b8e3ec8f43b3" 
		message="Serialized Coupon Found"/> <ee:transform doc:name="Transform Message" 
		doc:id="e9e5224b-1a95-4d1a-b216-556d9f23915c" > <ee:message > </ee:message> 
		<ee:variables > <ee:set-variable variableName="couponMetadata" ><![CDATA[%dw 
		2.0 output application/json fun getCheckNumber() = "9" ++ now().millisecond 
		fun getMonthString() = using(month = now().month as String) if(sizeOf(month) 
		== 1) ("00" ++ month) else "0" ++ month fun getDayString() = using(day = 
		now().day as String) if(sizeOf(day) == 1) ("00" ++ day) else "0" ++ day fun 
		getHourString() = using(hour = now().hour as String) if(sizeOf(hour) == 1) 
		("00" ++ hour) else "0" ++ hour fun getMinString() = using(min = now().minutes 
		as String) if(sizeOf(min) == 1) ("00" ++ min) else "0" ++ min fun getSecString() 
		= using(sec = now().seconds as String) if(sizeOf(sec) == 1) ("00" ++ sec) 
		else "0" ++ sec -&#45;&#45; { checkNumber: getCheckNumber(), checkSequence: 
		"8" ++ now().milliseconds, traceId: now() as DateTime {format: "yyMMddHHmmss"}, 
		//(now().year) ++ getMonthString() ++ getDayString() ++ getHourString() ++ 
		getMinString() ++ getSecString() ++ "N01" ++ getCheckNumber(), localTime: 
		now() as DateTime {format: "HHmmss"} }]]></ee:set-variable> </ee:variables> 
		</ee:transform> <ee:transform doc:name="acceptCouponXML" doc:id="a189fc92-34ee-40e2-a21c-0bb8ebe42f64" 
		> <ee:message > </ee:message> <ee:variables > <ee:set-variable variableName="acceptCouponXML" 
		><![CDATA[%dw 2.0 output application/xml -&#45;&#45; { SVCMessage @(version: 
		vars.lookupData.version as Number , timeout: vars.lookupData.timeOut as Number 
		, language: vars.lookupData.language , currency: vars.lookupData.currency 
		, sequence: vars.lookupData.sequence as Number): { RequestCode: vars.lookupData.requestCode, 
		CouponCode: payload.createcheck.serializedCoupon.couponCode, CheckSummary: 
		{ MenuItems: { (payload.createcheck.menuItems.resposapiMenuItem map ((value 
		, index) -> { MI @(ID: (value.menuItem.miAltItemId replace "a" with "") as 
		Number , QTY: vars.lookupData.quantity as Number): { "text()": value.menuItem.miPrice 
		} })) }, Totals @(ttlDue: payload.createcheck.payment.subtotalNoDiscountsPlusTaxes 
		as Number , ttlTax: payload.createcheck.payment.taxTotal as Number , ttlSvc: 
		vars.lookupData.amount as Number , ttlPay: vars.lookupData.amount as Number): 
		{ } }, TraceID: vars.couponMetadata.traceId, TerminalID: vars.lookupData.terminalId 
		as Number, TerminalType: vars.lookupData.terminalType, TipAmount: vars.lookupData.amount 
		as Number, Amount: vars.lookupData.amount as Number, LocalCurrency: vars.lookupData.currency, 
		LocalDate: vars.lookupData.localDate as Number, LocalTime: vars.couponMetadata.localTime, 
		PosPlatform: vars.lookupData.posPlatform as Number, BusinessDate: vars.lookupData.localDate 
		as Number, CheckNumber: vars.couponMetadata.checkNum as Number, CheckSequence: 
		vars.couponMetadata.checkSeq as Number, TransactionEmployee: vars.lookupData.employeeId 
		as Number, RevenueCenter: vars.lookupData.revenueCenter as Number, Site: 
		vars.lookupData.siteId } }]]></ee:set-variable> </ee:variables> </ee:transform> 
		</when> <otherwise > <set-variable value="#[{ &#10; methodName: 'CreateCheck', 
		&#10; storeId: if(vars.storeId != null) vars.storeId else vars.vrStoreId,, 
		&#10; checkNumber: 'Null', &#10; checkSequence: 'Null', &#10; employeeNumber: 
		'Null', &#10; tableNumber: 'Null', &#10; status: '1', &#10; message: &quot;No 
		serialized coupon found&quot; &#10;}]" doc:name="logData" doc:id="85919a9e-1292-486a-866a-2fc3259ed2d3" 
		variableName="logData"/> <flow-ref doc:name="insert-online-ordering-logs" 
		doc:id="84fb7aad-5e26-4ad9-aa87-0191ef2163eb" name="insert-online-ordering-logs" 
		/> </otherwise> </choice> </sub-flow> -->
</mule>
