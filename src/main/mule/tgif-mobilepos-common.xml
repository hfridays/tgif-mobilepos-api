<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd 
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd">
	<sub-flow name="get-store-ip-properties"
		doc:id="3446c974-5174-43c2-8b4c-5c522be84538">
		<logger level="INFO" doc:name="INFO: Enter"
			doc:id="b8f0cb8d-62da-4022-8456-401819f7d007"
			message="Enter Get Store IP Properties from Object Store" />
		<os:retrieve doc:name="Retrieve Store IP Properties"
			doc:id="aa43a799-ae44-4593-a1c9-562657e149ab" key="storeIpProperties"
			objectStore="Object_store" target="storeIpProperties" />
		<ee:transform doc:name="Store IP Properties"
			doc:id="676c0fa5-fd6f-41d1-9829-16d8ab460547">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="storeIpProperties"><![CDATA[%dw 2.0
output application/json
---
(vars.storeIpProperties.resultSet1 filter ($.store_id as String == vars.storeId)) map (item, index) -> {
	gatewayIp: item.gateway_ip,
	printerIp: item.printer_ip,
	serverIp: item.server_ip
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="INFO" doc:name="INFO: Exit"
			doc:id="3c2ea3e4-4819-429b-b5ed-27450682d43c"
			message="Exit Get Store IP properties from Object Store" />
	</sub-flow>

	<sub-flow name="get-error-code-details"
		doc:id="23dbee4c-8f7d-438d-827e-058574e2064f">
		<logger level="INFO" doc:name="INFO: Enter"
			doc:id="688520f8-fa4d-4f94-a8bb-14425d699d9f"
			message="Enter GetError Code Details from Object Store" />
		<os:retrieve doc:name="Retrieve Error Message Details" doc:id="2c701452-39a8-4cd9-b981-d5ffe6ad2b80" key="errorMessage" target="errorMessageDetails" objectStore="Object_store"/>
		<ee:transform doc:name="errorDescription" doc:id="1d50a3ca-20f2-4189-8d9b-389b3b9a1812">
							<ee:message>
							</ee:message>
							<ee:variables>
								<ee:set-variable variableName="errorDescription"><![CDATA[%dw 2.0
var arr = ((vars.errorMessageDetails filter ($.message_number as String == vars.errorCode)).custom_message_text)
var size = if(arr == null) 0 else sizeOf (arr)
output application/java
---
if((size>0)) (arr[0]) else (vars.errorCode ++ " This is a new error code. Kindly check with POS Team")]]></ee:set-variable>
							</ee:variables>
						</ee:transform>
		<logger level="INFO" doc:name="INFO: Exit" doc:id="c96a128e-97da-44fe-92a7-354e2b6bb69a" message="Exit GetError Code Details from Object Store"/>
	
</sub-flow>
	<sub-flow name="get-access-token"
		doc:id="9e17bb63-29b0-48ac-9696-21258c0576f0">
		<set-variable value="#[attributes.headers.ApiKey]"
			doc:name="reqAccessToken"
			doc:id="4d5d1ffb-b06c-4aa8-b520-cb9b5e9bcef5"
			variableName="reqAccessToken" />
		<set-variable value="${secure::api.token}"
			doc:name="accessToken" doc:id="cdeffd68-5412-4897-b94d-8b11e20b34b8"
			variableName="accessToken" />
	</sub-flow>
	<sub-flow name="insert-online-ordering-logs"
		doc:id="bbf9f077-8524-4446-a931-9ce93476faa1">
		<async doc:name="Async"
			doc:id="472df618-314f-46e3-a3fe-48216a55e64a">
			<db:stored-procedure
				doc:name="Insert Online Ordering Logs"
				doc:id="314a9d0d-b420-474d-8b13-3407bb99226f"
				config-ref="Database_Config_Mule_Interface">
				<db:sql><![CDATA[{ call dbo.prc_onlineordering_logs_insert(:method_name,:store_id,:check_number,:check_sequence,:employee_number,:table_number,:status,:message)}]]></db:sql>
				<db:input-parameters><![CDATA[#[{
	method_name: vars.logData.methodName,
	store_id: vars.logData.storeId,
	check_number: vars.logData.checkNumber,
	check_sequence: vars.logData.checkSequence,
	employee_number: vars.logData.employeeNumber,
	table_number: vars.logData.tableNumber,
	status: vars.logData.status,
	message: write(vars.logData.message, "application/json")
}]]]></db:input-parameters>
			</db:stored-procedure>
		</async>
	</sub-flow>
	<sub-flow name="insert-cart-id-logs"
		doc:id="3efb1c79-287e-454e-8a36-def5b1445be8">
		<async doc:name="Async"
			doc:id="f1f0d0ed-3a55-4b02-8b2c-5aab67e6d8e8">
			<db:stored-procedure
				doc:name="Insert Online Cart Id Details"
				doc:id="3fd0837a-87a8-4cc9-aa5a-c6370a66e55b"
				config-ref="Database_Config_Mule_Interface">
				<db:sql><![CDATA[{ call dbo.prc_olo_cart_id_details_insert(:store_id,:cart_id,:check_payload,:day_of_business)}]]></db:sql>
				<db:input-parameters><![CDATA[#[{
	store_id: vars.logData.storeId,
	cart_id: vars.logData.cartId,
	check_payload: write(vars.logData.payload, "application/json"),
	day_of_business: vars.logData.dayOfBusiness
}]]]></db:input-parameters>

			</db:stored-procedure>
		</async>
	</sub-flow>
		<sub-flow name="send-email-notification"
		doc:id="db3166c9-a40b-4688-bd8c-40bfa7c0c8e3">
		<logger level="INFO" doc:name="INFO: Logger"
					doc:id="a42c39b4-e8e7-47af-ac8b-d7eb924dd902"
					message="#[vars.emailMessage]" />
					<db:stored-procedure
			doc:name="Send Email Notification"
			doc:id="7036e2da-a22f-4152-a406-01bf54fc9155"
			config-ref="Database_Config_Depot" target="emailStatus">
			<db:sql><![CDATA[{call prc_RemoteMail_RouteMessage(:type, :subject,:body)}]]></db:sql>
			<db:input-parameters><![CDATA[#[{
	'type': "MobilePaymentNotification",
	subject: "Error occurred in Online Ordering API",
	body: vars.emailMessage
}]]]></db:input-parameters>
		</db:stored-procedure>
	</sub-flow>
	

</mule>
