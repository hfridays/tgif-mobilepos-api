<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:java="http://www.mulesoft.org/schema/mule/java"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/java http://www.mulesoft.org/schema/mule/java/current/mule-java.xsd">
	<sub-flow name="call-respos-api-tax-calculation"
		doc:id="16ce5e34-b00f-4ff7-ba52-3866c6c5cdc7">
		<ee:transform doc:name="Calculate Total Request XML"
			doc:id="5d1e4be2-e560-4e56-bdf5-86ad9a9d8068">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable
					variableName="calculateTotalXMLVars"><![CDATA[%dw 2.0
output application/json
---
{
	revenueCenter: vars.tenderId.calcTotalsRevenueCenterObjectNumber as Number,
	orderType: vars.tenderId.calcTotalsOrderTypeID as Number,
	employeeNumber: vars.tenderId.calcTotalsEmployeeObjectNum as Number
}
]]></ee:set-variable>
				<ee:set-variable
					resource="dwl/calculate-totals/calculate-totals-request.dwl"
					variableName="calculateTotalXML" />
			</ee:variables>
		</ee:transform>
		<set-variable
			value="#[output application/json
&#10;---
&#10;{
&#10;	methodName: 'CalculateTotals',
&#10;	storeId: if ( vars.storeId != null ) vars.storeId else vars.vrStoreId,
&#10;	checkNumber: 'Null',
&#10;	checkSequence: 'Null',
&#10;	employeeNumber: 'Null',
&#10;	tableNumber: 'Null',
&#10;	status: '1',
&#10;	message: vars.calculateTotalXML
&#10;}]"
			doc:name="logData" doc:id="54ff07de-456e-47fa-bddb-d42e998969c7"
			variableName="logData" />
		<flow-ref doc:name="insert-online-ordering-logs"
			doc:id="ae4aa838-c882-4d8a-ad72-bc3280a5e8cb"
			name="insert-online-ordering-logs" />
		<flow-ref doc:name="call-respos-api"
			doc:id="8194b696-2ec8-433e-9a9f-8dc2a26b6c0b" name="call-respos-api" />
		<choice doc:name="Check Response"
			doc:id="7007317a-c3c8-4feb-95a8-43fe52080abf">
			<when expression='#[payload.status == "Success"]'>
				<ee:transform doc:name="Create Success Response"
					doc:id="3f80eb84-a3c1-4110-b705-3ad156f77e8f">
					<ee:message>
						<ee:set-payload
							resource="dwl/calculate-totals/calculata-totals-success-reponse.dwl" />
					</ee:message>
				</ee:transform>
				<logger level="INFO" doc:name="INFO: Success"
					doc:id="b73eeda8-d205-45c8-882d-49eeffe73454"
					message="Calculate Total Flow completed successfully" />
			</when>
			<otherwise>
				<logger level="INFO" doc:name="INFO: ResPos API call failed"
					doc:id="90b0ade7-ec25-40b1-a9b0-b291961931d1"
					message="ResPos API call failed, Invalid Menu Items=#[vars.invalidMenuItems]" />
				<flow-ref doc:name="get-error-code-details"
					doc:id="454fbf8d-5f40-4f13-8f4e-0db6400e6347"
					name="get-error-code-details" />
				<ee:transform doc:name="Create Failure Response"
					doc:id="542d1d74-cf62-45a8-afdd-bb2009e16e2a">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
fun getPayload() = {
	calculatetotals: {
		result: {
			status: "failure",
			message: "input contains invalid menu items"
		},
		(menuItems: vars.invalidMenuItems map ((value , index) -> {
			miObjectNum: value.ResPosAPI_MenuItem.MenuItem.MiObjectNum,
			errorMessage: value.ResPosAPI_MenuItem.MenuItem.MiErrorMsg
		})) if (sizeOf(vars.invalidMenuItems) > 0)
	}
}
---
getPayload()]]></ee:set-payload>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="logData"><![CDATA[%dw 2.0
output application/json
---
{
	methodName: 'CalculateTotals',
	storeId: if ( vars.storeId != null ) vars.storeId else vars.vrStoreId,
	checkNumber: 'Null',
	checkSequence: 'Null',
	employeeNumber: 'Null',
	tableNumber: 'Null',
	status: '1',
	message: "CalculateTotals - Input contains bad menu items"
}]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="insert-online-ordering-logs"
					doc:id="d584017b-98e8-4f66-b6f6-99641e63c3a9"
					name="insert-online-ordering-logs" />
				<logger level="INFO" doc:name="INFO: Failure"
					doc:id="62bf96ee-8eb0-41eb-9f18-11d6e384ff0e"
					message="Calculate Total Flow completed unsuccessfully" />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="call-respos-api"
		doc:id="6c849360-805c-42ac-8207-49b19b205ca0">
		<foreach doc:name="For Each"
			doc:id="44a90a9c-cea1-43ad-af95-e8e7d6a0a663"
			collection="#[vars.calculateTotalXML.Envelope.Body.CalculateTransactionTotals.ppMenuItems]">
			<ee:transform doc:name="Create Respos Request"
				doc:id="9c26f72e-278c-4933-9158-4a716b4a086e">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="resPosRequest"><![CDATA[%dw 2.0
output application/xml
ns ns0 http://www.w3.org/2003/05/soap-envelope
ns ns1 http://schemas.micros.com/RESPOS
---
ns0#Envelope: {
	ns0#Body : {
		ns1#CalculateTransactionTotals: {
		ns1#ppMenuItems: payload,
		ns1#revenueCenter: vars.calculateTotalXMLVars.revenueCenter,
		ns1#orderType: vars.calculateTotalXMLVars.orderType,
		ns1#employeeNumber: vars.calculateTotalXMLVars.employeeNumber}
		
	}
}
]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<logger level="INFO" doc:name="DEBUG: Service Request"
				doc:id="8511d249-bbcd-48d2-bd40-5e00a328dc34"
				message="ResPos Api Request for menu item=#[vars.resPosRequest]" />
	 		<http:request method="POST" doc:name="Request ResPos Api" doc:id="7455a603-cb45-447b-ad5f-edddf6b15860" config-ref="HTTP_Request_configuration" path="/ResPosApiWeb/ResPosApiWeb.asmx" target="calculateTotalServiceResponse" sendCorrelationId="AUTO" responseTimeout="${microsApi.connectionTimeout}">
				<reconnect frequency="${resposapi.reconnect.frequency}" count="${resposapi.reconnect.count}" />
				<http:body><![CDATA[#[%dw 2.0
output text/xml
---
vars.resPosRequest]]]></http:body>
				<http:response-validator >
					<http:success-status-code-validator values="200..599" />
				</http:response-validator>
			
</http:request>
<!-- 			<set-variable value='#["&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;soap:Envelope xmlns:soap=\"http://www.w3.org/2003/05/soap-envelope\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"&gt;&lt;soap:Body&gt;&lt;soap:Fault&gt;&lt;soap:Code&gt;&lt;soap:Value&gt;soap:Receiver&lt;/soap:Value&gt;&lt;/soap:Code&gt;&lt;soap:Reason&gt;&lt;soap:Text xml:lang=\"en\"&gt;[-956234774] Invalid database object detected.&lt;/soap:Text&gt;&lt;/soap:Reason&gt;&lt;detail&gt;&lt;hresult&gt;-956234774&lt;/hresult&gt;&lt;/detail&gt;&lt;/soap:Fault&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;"]' doc:name="Set Variable" doc:id="97785ad2-47db-4de0-bb9d-22738004f48f" variableName="calculateTotalServiceResponse" mimeType="application/xml"/> -->
			<logger level="INFO" doc:name="DEBUG: Service Response"
				doc:id="fed4eb62-e80f-45af-aa68-eb8e50008b27"
				message="ResPos Api Response for menu item=#[vars.calculateTotalServiceResponse]" />
			<ee:transform doc:name="Create ResPos Response"
				doc:id="5aa04e7b-5199-4227-a48f-57fc986aed3d">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable
						variableName="calculateTotalServiceResponse"><![CDATA[%dw 2.0
output application/json
ns soapenv http://www.w3.org/2003/05/soap-envelope
ns respos http://schemas.micros.com/RESPOS
fun getErrDetail() = using ( faultBody = vars.calculateTotalServiceResponse.soapenv#Envelope.soapenv#Body.soapenv#Fault ) faultBody.detail.hresult replace "-" with "" 
fun getReason() = using ( faultBody = vars.calculateTotalServiceResponse.soapenv#Envelope.soapenv#Body.soapenv#Fault ) if ( faultBody.faultstring? ) faultBody.faultstring as String 
else faultBody.soapenv#Reason.soapenv#Text
---
if ( vars.calculateTotalServiceResponse.soapenv#Envelope.soapenv#Body.CalculateTransactionTotalsResponse != null ) {
	status: "Success",
	response: vars.calculateTotalServiceResponse.soapenv#Envelope.soapenv#Body.CalculateTransactionTotalsResponse
} else {
	status: "Failed",
	response: if ( getErrDetail() == "956234774" ) "Menu item or Condiment not found in POS"
				else if ( getErrDetail() == "956235772" ) "The menu level passed is out of range"
				else if ( getErrDetail() == "956235748" ) "Discount Object num is not an Item discount"
				else if ( getErrDetail() == "2147024809" ) "Not a valid Order discount object num"
				else getReason()
}
]]></ee:set-variable>
					<ee:set-variable variableName="invalidMenuItems" ><![CDATA[%dw 2.0
output application/java
---
[]]]></ee:set-variable>
				
</ee:variables>
			</ee:transform>
			<ee:transform doc:name="Invalid Menu Items"
				doc:id="86cbac72-ae6c-4f86-b1f9-3beaf9bf53d4">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="invalidMenuItems" ><![CDATA[%dw 2.0
output application/json
fun addErrMsg() =  {
	"MiObjectNum": payload.ResPosAPI_MenuItem.MenuItem.MiObjectNum,
	"MiMenuLevel": payload.ResPosAPI_MenuItem.MenuItem.MiMenuLevel,
	"ItemDiscount": {
		"DiscReference": payload.ResPosAPI_MenuItem.MenuItem.ItemDiscount.DiscReference
	},
	MiErrorMsg: vars.calculateTotalServiceResponse.response
}
---
if ( vars.calculateTotalServiceResponse.status == "Failed" ) vars.invalidMenuItems << (ResPosAPI_MenuItem: MenuItem: addErrMsg())
else vars.invalidMenuItems
]]></ee:set-variable>
				
</ee:variables>
			</ee:transform>
		</foreach>
		<logger level="INFO" doc:name="INFO: Invalid Menu Items" doc:id="c109390a-fc3c-486a-a717-e62aa2f577d4" message='#[vars.invalidMenuItems]'/>
		<choice doc:name="Any Invalid Menu Item?"
			doc:id="0a0e239a-f86a-49f8-b4ee-6e660a92e5b8">
			<when expression="#[sizeOf(vars.invalidMenuItems) == 0]">
				<logger level="INFO" doc:name="DEBUG: Service Request"
					doc:id="cb6a1a7e-12b8-4b3b-b24d-55a05467aef5"
					message="ResPosAPI Request=#[vars.calculateTotalXML]" />
				<http:request method="POST"
					doc:name="Request ResPos Api"
					doc:id="7fcc1feb-44db-4899-ae6e-a12910df9a87"
					config-ref="HTTP_Request_configuration"
					path="/ResPosApiWeb/ResPosApiWeb.asmx" sendCorrelationId="AUTO"
					responseTimeout="${microsApi.connectionTimeout}">
					<reconnect frequency="${resposapi.reconnect.frequency}"
						count="${resposapi.reconnect.count}" />
					<http:body><![CDATA[#[%dw 2.0
output text/xml
---
vars.calculateTotalXML]]]></http:body>
					<http:response-validator >
						<http:success-status-code-validator values="200..599" />
					</http:response-validator>
				
</http:request>
				<logger level="INFO" doc:name="DEBUG: Service Response"
					doc:id="c83cda3c-3fe7-4467-b499-fc1df859130e"
					message="ResPosAPI Response=#[payload]" />
				<ee:transform doc:name="Transform Message"
					doc:id="c1c2e71d-7b37-452f-9390-b66c6ee7870e">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
ns soapenv http://schemas.xmlsoap.org/soap/envelope/
---
if ( payload.soapenv#Envelope.soapenv#Body.CalculateTransactionTotalsResponse != null ) {
	status: "Success",
	response: payload.soapenv#Envelope.soapenv#Body.CalculateTransactionTotalsResponse
} else {
	status: "Failed",
	response: ((payload.soapenv#Envelope.soapenv#Body.soapenv#Fault.detail replace "}" with "" replace "{" with "") splitBy ":")[1] replace "-" with ""
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise>
				<set-variable value="100000001" doc:name="errorCode"
					doc:id="dc9b330a-3058-4254-a9eb-6c67ed62e991"
					variableName="errorCode" />
				<logger level="INFO"
					doc:name="INFO: Invalid Menu Items present"
					doc:id="f9f62d2b-d990-4a3b-955f-e725dd542a08"
					message="There are invalid menu items present in the request" />
			</otherwise>
		</choice>
	</sub-flow>
</mule>
