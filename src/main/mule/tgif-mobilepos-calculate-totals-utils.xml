<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:java="http://www.mulesoft.org/schema/mule/java"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/java http://www.mulesoft.org/schema/mule/java/current/mule-java.xsd">
	<sub-flow name="call-respos-api-taxt-total-caluclation"
		doc:id="16ce5e34-b00f-4ff7-ba52-3866c6c5cdc7">
		<ee:transform doc:name="Transform Message"
			doc:id="5d1e4be2-e560-4e56-bdf5-86ad9a9d8068">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable
					variableName="calculateTotalXMLVars"><![CDATA[%dw 2.0
output application/json
---
{
	revenueCenter: vars.tenderId.calcTotalsRevenueCenterObjectNumber as Number,
	orderType: vars.tenderId.calcTotalsOrderTypeID as Number,
	employeeNumber: vars.tenderId.calcTotalsEmployeeObjectNum as Number
}
]]></ee:set-variable>
				<ee:set-variable variableName="invalidMenuItems"><![CDATA[%dw 2.0
output application/json
---
[]]]></ee:set-variable>
				<ee:set-variable resource="dwl/calculate-totals/calculate-totals-request.dwl" variableName="calculateTotalXML" />
			
</ee:variables>
		</ee:transform>
		<set-variable
			value="#[output application/json
&#10;---
&#10;{
&#10;	methodName: 'CalculateTotals',
&#10;	storeId: if ( vars.storeId != null ) vars.storeId else vars.vrStoreId,
&#10;	checkNumber: 'Null',
&#10;	checkSequence: 'Null',
&#10;	employeeNumber: 'Null',
&#10;	tableNumber: 'Null',
&#10;	status: '1',
&#10;	message: vars.calculateTotalXML
&#10;}]"
			doc:name="logData" doc:id="54ff07de-456e-47fa-bddb-d42e998969c7"
			variableName="logData" />
		<flow-ref doc:name="insert-online-ordering-logs"
			doc:id="ae4aa838-c882-4d8a-ad72-bc3280a5e8cb"
			name="insert-online-ordering-logs" />
		<flow-ref doc:name="call-resposapi-for-each-menu-item"
			doc:id="8194b696-2ec8-433e-9a9f-8dc2a26b6c0b"
			name="call-resposapi-for-each-menu-item" />
		<choice doc:name="Choice"
			doc:id="7007317a-c3c8-4feb-95a8-43fe52080abf">
			<when
				expression='#[vars.calculateTotalServiceResponse.status == "Success"]'>
				<logger level="INFO" doc:name="DEBUG: Service Request" doc:id="cb6a1a7e-12b8-4b3b-b24d-55a05467aef5" message="#[vars.calculateTotalXML]"/>
				<http:request method="POST"
					doc:name="Request ResPos Api"
					doc:id="7fcc1feb-44db-4899-ae6e-a12910df9a87"
					config-ref="HTTP_Request_configuration"
					path="/ResPosApiWeb/ResPosApiWeb.asmx"
					sendCorrelationId="AUTO"
					responseTimeout="${microsApi.connectionTimeout}">
					<reconnect frequency="${resposapi.reconnect.frequency}"
						count="${resposapi.reconnect.count}" />
					<http:body><![CDATA[#[vars.calculateTotalXML]]]></http:body>
				</http:request>
				<logger level="INFO" doc:name="DEBUG: Service Response" doc:id="c83cda3c-3fe7-4467-b499-fc1df859130e" message="#[payload]"/>
				<ee:transform doc:name="Create Success Response"
					doc:id="3f80eb84-a3c1-4110-b705-3ad156f77e8f">
					<ee:message>
						<ee:set-payload resource="dwl/calculate-totals/calculata-totals-success-reponse.dwl" />
					
</ee:message>
				</ee:transform>
				<logger level="INFO" doc:name="INFO: Success"
					doc:id="b73eeda8-d205-45c8-882d-49eeffe73454"
					message="Calculate Total Flow completed successfully" />
			
</when>
			<otherwise>
				<logger level="INFO" doc:name="INFO: ResPos API call failed"
					doc:id="90b0ade7-ec25-40b1-a9b0-b291961931d1"
					message="ResPos API call failed" />
				<set-variable
					value="#[vars.calculateTotalServiceResponse.response]"
					doc:name="errorCode" doc:id="35ca27e0-f36c-4c77-843d-0fa11a059d48"
					variableName="errorCode" />
				<flow-ref doc:name="get-error-code-details"
					doc:id="454fbf8d-5f40-4f13-8f4e-0db6400e6347"
					name="get-error-code-details" />
				<ee:transform doc:name="Create Failure Response"
					doc:id="542d1d74-cf62-45a8-afdd-bb2009e16e2a">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	calculatetotals: {
		result: {
			status: "Failure",
			message: if ( vars.errorCode == "Store server not reachable, able to reach Firewall" ) "Unable to reach store server" 
			else if ( vars.errorCode == "Store network unreachable at Firewall" ) "Unable to reach store network"
			else vars.invalidMenuItems
		}
	}
}]]></ee:set-payload>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="emailMessage"><![CDATA[%dw 2.0
output application/json
---
if ( vars.errorCode == "Store server not reachable, able to reach Firewall" ) "Store Network reachable and store Server unreachable for store " ++ vars.storeId ++ " in CalculateTotals method"
else if ( vars.errorCode == "Store network unreachable at Firewall" ) "Store Network unreachable for store " ++ vars.storeId ++ " in CalculateTotals method"
else if ( vars.errorCode == "100000001" ) vars.invalidMenuItems
else ""]]></ee:set-variable>
						<ee:set-variable variableName="logData"><![CDATA[%dw 2.0
output application/json
---
{
	methodName: 'CalculateTotals',
	storeId: if ( vars.storeId != null ) vars.storeId else vars.vrStoreId,
	checkNumber: 'Null',
	checkSequence: 'Null',
	employeeNumber: 'Null',
	tableNumber: 'Null',
	status: '1',
	message: if ( vars.errorCode == "Store server not reachable, able to reach Firewall" ) "Unable to reach store server"
	else if ( vars.errorCode == "Store network unreachable at Firewall" ) "Unable to reach store network"
	else if ( vars.errorCode == "100000001" ) "CalculateTotals - Input contains bad menu items"
	else ""
}]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="send-email-notification"
					doc:id="6f6a694c-5f7f-47b4-b9df-fc1039056732"
					name="send-email-notification" />
				<flow-ref doc:name="insert-online-ordering-logs"
					doc:id="d584017b-98e8-4f66-b6f6-99641e63c3a9"
					name="insert-online-ordering-logs" />
				<logger level="INFO" doc:name="INFO: Failure"
					doc:id="62bf96ee-8eb0-41eb-9f18-11d6e384ff0e"
					message="Calculate Total Flow completed unsuccessfully" />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="call-resposapi-for-each-menu-item"
		doc:id="6c849360-805c-42ac-8207-49b19b205ca0">
		<foreach doc:name="For Each"
			doc:id="44a90a9c-cea1-43ad-af95-e8e7d6a0a663"
			collection="#[vars.calculateTotalXML.Envelope.Body.CalculateTransactionTotals.ppMenuItems.ResPosAPI_MenuItem]">
			<ee:transform doc:name="Create Respos Request"
				doc:id="9c26f72e-278c-4933-9158-4a716b4a086e">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="resPosRequest"><![CDATA[%dw 2.0
output text/plain
---
"<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<ns0:Envelope xmlns:ns0=\"http://www.w3.org/2003/05/soap-envelope\">
	<ns0:Body>
		<ns1:CalculateTransactionTotals xmlns:ns1=\"http://schemas.micros.com/RESPOS\">
			<ns1:ppMenuItems>" ++ write(payload, "application/xml", {"writeDeclaration":false}) ++
			"</ns1:ppMenuItems>
				<ns1:revenueCenter>" ++ vars.calculateTotalXMLVars.revenueCenter ++ "</ns1:revenueCenter>
				<ns1:orderType>"++ vars.calculateTotalXMLVars.orderType ++ "</ns1:orderType>
				<ns1:employeeNumber>" ++ vars.calculateTotalXMLVars.employeeNumber ++ "</ns1:employeeNumber>
		</ns1:CalculateTransactionTotals>
	</ns0:Body>
</ns0:Envelope>"]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<!-- <http:request method="POST" -->
			<!-- doc:name="Request ResPos Api" -->
			<!-- doc:id="7455a603-cb45-447b-ad5f-edddf6b15860" -->
			<!-- config-ref="HTTP_Request_configuration" -->
			<!-- path="/ResPosApiWeb/ResPosApiWeb.asmx" -->
			<!-- target="calculateTotalServiceResponse" sendCorrelationId="AUTO" responseTimeout="${microsApi.connectionTimeout}"> -->
			<!-- <reconnect frequency="${resposapi.reconnect.frequency}" -->
			<!-- count="${resposapi.reconnect.count}" /> -->
			<!-- <http:body ><![CDATA[#[vars.resPosRequest]]]></http:body> -->
			<!-- </http:request> -->

			<set-variable
				value="#[&quot;&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&#10;&lt;soap:Envelope
&#10;	xmlns:soap='http://www.w3.org/2003/05/soap-envelope'
&#10;	xmlns:xsi='http://www.w3.org/2001/XMLSchema-instance'
&#10;	xmlns:xsd='http://www.w3.org/2001/XMLSchema'&gt;
&#10;	&lt;soap:Body&gt;
&#10;		&lt;CalculateTransactionTotalsResponse
&#10;			xmlns='http://schemas.micros.com/RESPOS'&gt;
&#10;			&lt;ppMenuItems&gt;
&#10;				&lt;ResPosAPI_MenuItem&gt;
&#10;					&lt;MenuItem&gt;
&#10;						&lt;MiObjectNum&gt;1005&lt;/MiObjectNum&gt;
&#10;						&lt;MiMenuLevel&gt;5&lt;/MiMenuLevel&gt;
&#10;						&lt;MiOverridePrice&gt;11.99&lt;/MiOverridePrice&gt;
&#10;						&lt;ItemDiscount&gt;
&#10;							&lt;DiscObjectNum&gt;0&lt;/DiscObjectNum&gt;
&#10;							&lt;DiscReference&gt;0&lt;/DiscReference&gt;
&#10;						&lt;/ItemDiscount&gt;
&#10;					&lt;/MenuItem&gt;
&#10;				&lt;/ResPosAPI_MenuItem&gt;
&#10;			&lt;/ppMenuItems&gt;
&#10;			&lt;pSvcCharge&gt;
&#10;				&lt;SvcChgObjectNum&gt;0&lt;/SvcChgObjectNum&gt;
&#10;			&lt;/pSvcCharge&gt;
&#10;			&lt;pSubtotalDiscount&gt;
&#10;				&lt;DiscObjectNum&gt;0&lt;/DiscObjectNum&gt;
&#10;			&lt;/pSubtotalDiscount&gt;
&#10;			&lt;pTotalsResponse&gt;
&#10;				&lt;TotalsSubTotal&gt;11.99&lt;/TotalsSubTotal&gt;
&#10;				&lt;TotalsTaxTotals&gt;0.84&lt;/TotalsTaxTotals&gt;
&#10;				&lt;TotalsOtherTotals&gt;0.00&lt;/TotalsOtherTotals&gt;
&#10;				&lt;TotalsAutoSvcChgTotals&gt;0.00&lt;/TotalsAutoSvcChgTotals&gt;
&#10;				&lt;TotalsTotalDue&gt;12.83&lt;/TotalsTotalDue&gt;
&#10;			&lt;/pTotalsResponse&gt;
&#10;		&lt;/CalculateTransactionTotalsResponse&gt;
&#10;	&lt;/soap:Body&gt;
&#10;&lt;/soap:Envelope&gt;&quot;]"
				doc:name="Set Variable"
				doc:id="e73a1565-3d4f-4976-8996-23f781ca8747"
				variableName="calculateTotalServiceResponse"
				mimeType="application/xml" />
			<ee:transform doc:name="Create ResPos Response"
				doc:id="5aa04e7b-5199-4227-a48f-57fc986aed3d">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable
						variableName="calculateTotalServiceResponse"><![CDATA[%dw 2.0
output application/json
ns soapenv http://www.w3.org/2003/05/soap-envelope
ns respos http://schemas.micros.com/RESPOS
fun getErrDetail() = using ( faultBody = vars.calculateTotalServiceResponse.soapenv#Envelope.soapenv#Body.soapenv#Fault ) if ( faultBody.detail? ) ((faultBody.detail replace "}" with "" replace "{" with "") splitBy ":")[1] replace "-" with "" 
else if ( faultBody.faultstring? ) faultBody.faultstring as String
else faultBody.soapenv#Reason.soapenv#Text
---
if ( vars.calculateTotalServiceResponse.soapenv#Envelope.soapenv#Body.CalculateTransactionTotalsResponse != null ) {
	status: "Success",
	response: vars.calculateTotalServiceResponse.soapenv#Envelope.soapenv#Body.CalculateTransactionTotalsResponse
} else {
	status: "Failed",
response: if ( getErrDetail() == "956234774" ) "Menu item or Condiment not found in POS"
				else if ( getErrDetail() == "956235772" ) "The menu level passed is out of range"
				else if ( getErrDetail() == "956235748" ) "Discount Object num is not an Item discount"
				else if ( getErrDetail() == "2147024809" ) "Not a valid Order discount object num"
				else getErrDetail() }
]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<ee:transform doc:name="Transform Message"
				doc:id="86cbac72-ae6c-4f86-b1f9-3beaf9bf53d4">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="invalidMeniItems"><![CDATA[%dw 2.0
output application/json
---
if ( vars.calculateTotalServiceResponse.status == "Success" ) vars.invalidMenuItems ++ (payload.MenuItem ++ read("<MiErrorMsg>" ++ vars.calculateTotalServiceResponse.response ++ "</MiErrorMsg>", "application/xml"))
else vars.inValidMenuItems]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</foreach>
	</sub-flow>
</mule>
